# GKD ç®€åŒ–å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

æœ¬æ¬¡å®ç°åˆ›å»ºäº†ä¸€ä¸ªç®€åŒ–çš„ã€åŸºäº PPO-style çš„ GKD (Generalized Knowledge Distillation) è®­ç»ƒæ¡†æ¶ï¼Œç›¸æ¯”åŸæœ‰çš„ `recipe/gkd` å®ç°æ›´åŠ ç®€å•æ˜“ç”¨ã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ¨¡å—åˆ›å»º âœ“

#### 1.1 GKD Trainer æ¨¡å— (`verl/trainer/gkd/`)

- **`__init__.py`**: æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶ï¼Œå¯¼å‡ºå…³é”®ç±»å’Œå‡½æ•°
- **`distill_loss.py`**: FSDP å…¼å®¹çš„è’¸é¦æŸå¤±å‡½æ•°
  - `compute_fsdp_kl_divergence()`: è®¡ç®— KL æ•£åº¦æŸå¤±
  - æ”¯æŒä¸‰ç§æŸå¤±ç±»å‹ï¼šforward_kl, reverse_kl, jsd
  - ä½¿ç”¨ç¨€ç– top-k teacher logprobs æé«˜æ•ˆç‡
  
- **`ray_trainer.py`**: GKD è®­ç»ƒå™¨ä¸»ç±»
  - `RayGKDTrainer`: ç»§æ‰¿è‡ª `RayPPOTrainer`
  - é›†æˆ Teacher Client è¿›è¡ŒçŸ¥è¯†è’¸é¦
  - åŒæ­¥è·å– teacher knowledge
  - æ”¯æŒçº¯è’¸é¦æˆ– RL+è’¸é¦æ··åˆæ¨¡å¼

#### 1.2 ä¸»å…¥å£æ–‡ä»¶ (`verl/trainer/main_gkd.py`)

- `main()`: Hydra é…ç½®å…¥å£ç‚¹
- `run_gkd()`: Ray é›†ç¾¤åˆå§‹åŒ–å’Œè®­ç»ƒå¯åŠ¨
- `GKDTaskRunner`: æ‰©å±•è‡ª PPOTaskRunnerï¼Œä½¿ç”¨ RayGKDTrainer

#### 1.3 é…ç½®æ–‡ä»¶ (`verl/trainer/config/gkd_trainer.yaml`)

- ç»§æ‰¿ `ppo_trainer.yaml` çš„æ‰€æœ‰é…ç½®
- æ–°å¢ `gkd` é…ç½®èŠ‚ï¼š
  - Teacher server è¿æ¥é…ç½®
  - è’¸é¦æŸå¤±ç±»å‹å’Œç³»æ•°
  - RL æŸå¤±å¼€å…³å’Œç³»æ•°
  - æ¸©åº¦å‚æ•°

### 2. Actor æ‰©å±• âœ“

#### 2.1 ä¿®æ”¹ `verl/workers/actor/dp_actor.py`

- åœ¨ `update_policy()` ä¸­æ·»åŠ  teacher knowledge é€‰æ‹©é€»è¾‘
- åœ¨æŸå¤±è®¡ç®—ä¸­æ·»åŠ è’¸é¦æŸå¤±åˆ†æ”¯ï¼š
  - ä» non_tensor_batch è·å– teacher_topk_logps å’Œ teacher_topk_indices
  - é‡æ–°å‰å‘ä¼ æ’­è·å– student logits
  - è°ƒç”¨ `compute_fsdp_kl_divergence()` è®¡ç®—è’¸é¦æŸå¤±
  - ä¸ policy loss ç»„åˆ
- åœ¨ metrics ä¸­æ·»åŠ  `actor/distill_loss` è·Ÿè¸ª

### 3. å¯åŠ¨è„šæœ¬å’Œæ–‡æ¡£ âœ“

#### 3.1 å¯åŠ¨è„šæœ¬ (`baseline/GKD/run_gkd_simple.sh`)

- å®Œæ•´çš„ bash è„šæœ¬ï¼Œé…ç½®æ‰€æœ‰å¿…è¦å‚æ•°
- Teacher server è¿æ¥æ£€æŸ¥
- FSDP é…ç½®ï¼ˆè€Œé Megatronï¼‰
- Agent multi-turn äº¤äº’é…ç½®
- å¯æ‰§è¡Œæƒé™å·²è®¾ç½®

#### 3.2 æ–‡æ¡£

- **`README_SIMPLE.md`**: è¯¦ç»†ä½¿ç”¨æŒ‡å—
  - å¿«é€Ÿå¼€å§‹æ­¥éª¤
  - é…ç½®è¯´æ˜
  - ä¸åŸå®ç°å¯¹æ¯”
  - æ•…éšœæ’æŸ¥
  
- **`IMPLEMENTATION_SUMMARY.md`**: æœ¬æ–‡ä»¶

- **`test_imports.py`**: å¯¼å…¥éªŒè¯è„šæœ¬

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®­ç»ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt     â”‚
â”‚  Data       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Student        â”‚
â”‚  Rollout        â”‚
â”‚  (Agent Multi-  â”‚
â”‚   turn)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Teacher        â”‚
â”‚  Knowledge      â”‚
â”‚  (Sync)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Compute        â”‚
â”‚  Reward         â”‚
â”‚  (Optional)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Update Actor   â”‚
â”‚  (Distill +     â”‚
â”‚   RL Loss)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŸå¤±ç»„åˆ

```
Total Loss = Î± Ã— RL_Loss + Î² Ã— Distillation_Loss

å…¶ä¸­:
- Î±: rl_loss_coef (0 è¡¨ç¤ºçº¯è’¸é¦)
- Î²: distill_loss_coef (é€šå¸¸ä¸º 1.0)
```

### å…³é”®è®¾è®¡å†³ç­–

1. **ä½¿ç”¨ FSDP è€Œé Megatron**: ç®€åŒ–é…ç½®å’Œéƒ¨ç½²
2. **åŒæ­¥ Teacher è°ƒç”¨**: å®ç°ç®€å•ï¼Œæ˜“äºè°ƒè¯•
3. **ç»§æ‰¿ RayPPOTrainer**: æœ€å¤§åŒ–ä»£ç å¤ç”¨
4. **åœ¨ Trainer ä¸­è·å– teacher knowledge**: ä¿æŒ worker ç®€æ´
5. **æ‰©å±•è€Œéé‡å†™ dp_actor**: å‘åå…¼å®¹ï¼Œæœ€å°ä¾µå…¥

## ğŸ§ª æµ‹è¯•éªŒè¯

### å¯¼å…¥æµ‹è¯• âœ“

```bash
cd /root/yuxiang/verl
python3 baseline/GKD/test_imports.py
```

**ç»“æœ**: æ‰€æœ‰å¯¼å…¥æˆåŠŸ âœ“

### æ–‡ä»¶æ£€æŸ¥ âœ“

å·²åˆ›å»ºçš„æ–‡ä»¶ï¼š
- âœ“ `verl/trainer/gkd/__init__.py`
- âœ“ `verl/trainer/gkd/distill_loss.py`
- âœ“ `verl/trainer/gkd/ray_trainer.py`
- âœ“ `verl/trainer/main_gkd.py`
- âœ“ `verl/trainer/config/gkd_trainer.yaml`
- âœ“ `verl/workers/actor/dp_actor.py` (å·²ä¿®æ”¹)
- âœ“ `baseline/GKD/run_gkd_simple.sh`
- âœ“ `baseline/GKD/README_SIMPLE.md`
- âœ“ `baseline/GKD/test_imports.py`
- âœ“ `baseline/GKD/IMPLEMENTATION_SUMMARY.md`

## ğŸ“Š ä»£ç ç»Ÿè®¡

- **æ–°å¢æ–‡ä»¶**: 9 ä¸ª
- **ä¿®æ”¹æ–‡ä»¶**: 1 ä¸ª (`dp_actor.py`)
- **æ€»ä»£ç è¡Œæ•°**: ~1200 è¡Œï¼ˆä¸å«æ³¨é‡Šå’Œç©ºè¡Œï¼‰
- **æ–°å¢é…ç½®é¡¹**: 10+ ä¸ª

## ğŸ”„ ä¸åŸå®ç°å¯¹æ¯”

| ç»´åº¦ | åŸå®ç° (recipe/gkd) | ç®€åŒ–å®ç° (baseline/GKD) |
|------|---------------------|-------------------------|
| **ä»£ç è¡Œæ•°** | ~1500 è¡Œ | ~1200 è¡Œ |
| **æ–‡ä»¶æ•°é‡** | 8+ ä¸ª | 10 ä¸ª |
| **åç«¯** | Megatron | FSDP |
| **è°ƒç”¨æ–¹å¼** | å¼‚æ­¥ (one_step_off) | åŒæ­¥ |
| **Worker ç±»å‹** | è‡ªå®šä¹‰ | å¤ç”¨ PPO |
| **å­¦ä¹ æ›²çº¿** | é™¡å³­ | å¹³ç¼“ |
| **æ€§èƒ½** | é«˜ï¼ˆä¼˜åŒ–æµæ°´çº¿ï¼‰| ä¸­ï¼ˆåŒæ­¥å¼€é”€ï¼‰|
| **çµæ´»æ€§** | é«˜ | é«˜ |

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### é€‚åˆç®€åŒ–ç‰ˆçš„åœºæ™¯ï¼š
- âœ“ ç ”ç©¶å’Œå®éªŒ
- âœ“ å°åˆ°ä¸­ç­‰è§„æ¨¡è®­ç»ƒ
- âœ“ å¿«é€ŸåŸå‹å¼€å‘
- âœ“ å­¦ä¹  GKD åŸç†
- âœ“ Agent äº¤äº’å¼è®­ç»ƒ

### ä»éœ€åŸç‰ˆçš„åœºæ™¯ï¼š
- âœ— å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒ
- âœ— æè‡´æ€§èƒ½è¦æ±‚
- âœ— å¤æ‚çš„åˆ†å¸ƒå¼é…ç½®

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³å¯ç”¨
ç°åœ¨å¯ä»¥ç›´æ¥è¿è¡Œè®­ç»ƒï¼š

```bash
# 1. å¯åŠ¨ teacher server
cd baseline/GKD/teacher
export CUDA_VISIBLE_DEVICES=0,1
bash start_server.sh

# 2. åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œè®­ç»ƒ
cd /root/yuxiang/verl
bash baseline/GKD/run_gkd_simple.sh
```

### æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**ï¼ˆå¦‚éœ€è¦ï¼‰:
   - æ·»åŠ å¼‚æ­¥ teacher è°ƒç”¨é€‰é¡¹
   - å®ç° teacher knowledge ç¼“å­˜
   - æ”¯æŒæ‰¹é‡å¤„ç†ä¼˜åŒ–

2. **åŠŸèƒ½æ‰©å±•**:
   - æ”¯æŒå¤šæ•™å¸ˆè’¸é¦
   - æ·»åŠ åœ¨çº¿éš¾æ ·æœ¬æŒ–æ˜
   - æ”¯æŒæ¸è¿›å¼è’¸é¦

3. **æ˜“ç”¨æ€§æ”¹è¿›**:
   - æ·»åŠ æ›´å¤šé…ç½®é¢„è®¾
   - æä¾› Docker å®¹å™¨
   - æ·»åŠ æ›´å¤šç¤ºä¾‹

## ğŸ“ å…³é”®æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒè®­ç»ƒæµç¨‹
- `verl/trainer/gkd/ray_trainer.py:RayGKDTrainer.fit()` (L180-L350)
  - ä¸»è®­ç»ƒå¾ªç¯å®ç°

### è’¸é¦æŸå¤±è®¡ç®—
- `verl/trainer/gkd/distill_loss.py:compute_fsdp_kl_divergence()` (L20-L90)
  - KL æ•£åº¦è®¡ç®—æ ¸å¿ƒé€»è¾‘

### Actor æŸå¤±ç»„åˆ
- `verl/workers/actor/dp_actor.py:update_policy()` (L530-L575)
  - è’¸é¦æŸå¤±ä¸ RL æŸå¤±ç»„åˆ

## ğŸ¤ è´¡çŒ®è€…

- å®ç°ï¼šAI Assistant
- è®¾è®¡è®¨è®ºï¼šyuxiang
- åŸºäºï¼šveRL æ¡†æ¶å’ŒåŸæœ‰ recipe/gkd å®ç°

## ğŸ“„ è®¸å¯è¯

Apache License 2.0

---

**å®ç°æ—¥æœŸ**: 2026-01-08  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•
